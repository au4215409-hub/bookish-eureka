name: WhatsApp Automation with MuMu Emulator

on:
  workflow_dispatch: # Manual trigger only

jobs:
  whatsapp-automation:
    runs-on: windows-latest
    timeout-minutes: 3600 # 60 hour maximum

    steps:
    - name: Create RDP User with Password
      run: |
        Write-Host "=== CREATING RDP USER ==="
        $password = "Jalingo@1"
        $securePassword = ConvertTo-SecureString $password -AsPlainText -Force
        New-LocalUser -Name "RDPUser" -Password $securePassword -AccountNeverExpires
        Add-LocalGroupMember -Group "Administrators" -Member "RDPUser"
        Add-LocalGroupMember -Group "Remote Desktop Users" -Member "RDPUser"
        Write-Host "‚úÖ RDP User created: RDPUser"
        Write-Host "‚úÖ Password: $password"

    - name: Enable RDP
      run: |
        Write-Host "=== ENABLING RDP ==="
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
        Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
        netsh advfirewall firewall set rule group="remote desktop" new enable=Yes
        Restart-Service -Name TermService -Force
        Write-Host "‚úÖ RDP enabled"

    - name: Create WhatsApp Directory
      run: |
        Write-Host "=== CREATING WHATSAPP DIRECTORY ==="
        $whatsappDir = "C:\Users\RDPUser\Desktop\whatsapp"
        New-Item -ItemType Directory -Force -Path $whatsappDir
        Write-Host "‚úÖ Directory created: $whatsappDir"

    - name: Download repository files
      run: |
        Write-Host "=== DOWNLOADING REPOSITORY FILES ==="
        $whatsappDir = "C:\Users\RDPUser\Desktop\whatsapp"
        Invoke-WebRequest -Uri "https://github.com/binahmad362/stunning-carnival/archive/refs/heads/main.zip" -OutFile "$whatsappDir\repo.zip"
        Expand-Archive -Path "$whatsappDir\repo.zip" -DestinationPath "$whatsappDir\temp" -Force
        Get-ChildItem "$whatsappDir\temp\stunning-carnival-main\*" | Move-Item -Destination $whatsappDir -Force
        Remove-Item "$whatsappDir\temp" -Recurse -Force
        Remove-Item "$whatsappDir\repo.zip" -Force
        Write-Host "‚úÖ Repository files downloaded"

    - name: Download MuMu Files
      run: |
        Write-Host "=== DOWNLOADING MUMU FILES ==="
        $whatsappDir = "C:\Users\RDPUser\Desktop\whatsapp"
        Invoke-WebRequest -Uri "https://a11.gdl.netease.com/MuMu_5.0.4_gw-win-download_all_1756402042.exe?n=MuMu_5.0.4_r9kVqqC.exe" -OutFile "$whatsappDir\MuMu_Installer.exe"
        Write-Host "‚úÖ MuMu Installer downloaded"
        Invoke-WebRequest -Uri "https://github.com/binahmad362/glowing-guide/raw/refs/heads/main/Android%20Device.mumudata?download=" -OutFile "$whatsappDir\Android_Device.mumudata"
        Write-Host "‚úÖ Android Device data downloaded"

    - name: Install Python Dependencies
      run: |
        Write-Host "=== INSTALLING PYTHON DEPENDENCIES ==="
        pip install pyautogui keyboard requests opencv-python pillow
        Write-Host "‚úÖ Python dependencies installed"

    - name: Create Persistent Script Launcher
      run: |
        Write-Host "=== CREATING PERSISTENT SCRIPT LAUNCHER ==="
        $whatsappDir = "C:\Users\RDPUser\Desktop\whatsapp"
        
        # Create a batch file that will run the script in a persistent way
        @"
@echo off
echo Starting WhatsApp Automation...
echo This script will continue running even if RDP disconnects.
cd /d "C:\Users\RDPUser\Desktop\whatsapp"

:: Set display to stay active
powershell -command "Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.Application]::SetSuspendState('Suspend', \$false, \$false)"

:: Run the Python script
python script.py

echo Script finished. Press any key to exit...
pause
"@ | Out-File -FilePath "$whatsappDir\run_persistent.bat" -Encoding ASCII

        # Also create a scheduled task to keep the session alive
        @"
@echo off
echo Session keep-alive running...
cd /d "C:\Users\RDPUser\Desktop\whatsapp"

:loop
:: Move mouse slightly to keep session active
powershell -command "Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.Cursor]::Position = New-Object System.Drawing.Point(([System.Windows.Forms.Cursor]::Position.X + 1), [System.Windows.Forms.Cursor]::Position.Y)"
timeout /t 60 /nobreak > nul
goto loop
"@ | Out-File -FilePath "$whatsappDir\keep_alive.bat" -Encoding ASCII

        Write-Host "‚úÖ Persistent launchers created"

    - name: Start Keep-Alive Session
      run: |
        Write-Host "=== STARTING KEEP-ALIVE SESSION ==="
        $whatsappDir = "C:\Users\RDPUser\Desktop\whatsapp"
        
        # Start the keep-alive script in background
        Start-Process -FilePath "cmd.exe" -ArgumentList "/c start $whatsappDir\keep_alive.bat" -WindowStyle Hidden
        
        Write-Host "‚úÖ Keep-alive session started"

    - name: Download Cloudflared
      run: |
        Write-Host "=== DOWNLOADING CLOUDFLARED ==="
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "cloudflared.exe"
        Write-Host "‚úÖ Cloudflared downloaded"

    - name: Start Cloudflare Tunnel and Provide Instructions
      run: |
        Write-Host "=== STARTING CLOUDFLARE TUNNEL ==="
        Write-Host "üéâ ENVIRONMENT READY! üéâ"
        Write-Host ""
        Write-Host "üìã RDP CONNECTION DETAILS:"
        Write-Host "   Username: RDPUser"
        Write-Host "   Password: Jalingo@1"
        Write-Host ""
        Write-Host "üöÄ IMPORTANT INSTRUCTIONS:"
        Write-Host "   1. Connect via RDP using the Cloudflared URL below"
        Write-Host "   2. Once connected, run 'run_persistent.bat' from the desktop"
        Write-Host "   3. The script will continue even if you disconnect RDP"
        Write-Host "   4. Reconnect anytime to check progress"
        Write-Host ""
        Write-Host "üîß SESSION FEATURES:"
        Write-Host "   ‚úÖ Keep-alive script running in background"
        Write-Host "   ‚úÖ Script continues when RDP disconnects"
        Write-Host "   ‚úÖ Reconnect anytime to monitor progress"
        Write-Host ""
        Write-Host "üåê CLOUDFLARE TUNNEL STARTING..."
        Write-Host "   Your RDP connection URL will appear below:"
        Write-Host "   This will keep running for 6 hours"
        Write-Host ""
        
        # Start cloudflared tunnel
        Start-Process -FilePath ".\cloudflared.exe" -ArgumentList "tunnel --url rdp://localhost:3389" -NoNewWindow
        
        # Wait for tunnel to establish
        Start-Sleep -Seconds 10
        
        Write-Host "=== TUNNEL ACTIVE ==="
        Write-Host "Waiting for 6 hours or until manually stopped..."
        
        # Keep the workflow running for 6 hours
        Start-Sleep -Seconds 21600

    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: whatsapp-automation-results
        path: C:\Users\RDPUser\Desktop\whatsapp\
        retention-days: 1
