name: WhatsApp Automation with MuMu Emulator (Browser Access)

on:
  workflow_dispatch: # Manual trigger only

jobs:
  whatsapp-automation:
    runs-on: windows-latest
    timeout-minutes: 3600 # 60 hour maximum

    steps:
    - name: Create WhatsApp Directory
      run: |
        Write-Host "=== CREATING WHATSAPP DIRECTORY ==="
        $whatsappDir = "C:\whatsapp-automation"
        New-Item -ItemType Directory -Force -Path $whatsappDir
        Write-Host "‚úÖ Directory created: $whatsappDir"

    - name: Download repository files
      run: |
        Write-Host "=== DOWNLOADING REPOSITORY FILES ==="
        $whatsappDir = "C:\whatsapp-automation"
        Invoke-WebRequest -Uri "https://github.com/binahmad362/refactored-waddle/archive/refs/heads/main.zip" -OutFile "$whatsappDir\repo.zip"
        Expand-Archive -Path "$whatsappDir\repo.zip" -DestinationPath "$whatsappDir\temp" -Force
        Get-ChildItem "$whatsappDir\temp\refactored-waddle-main\*" | Move-Item -Destination $whatsappDir -Force
        Remove-Item "$whatsappDir\temp" -Recurse -Force
        Remove-Item "$whatsappDir\repo.zip" -Force
        Write-Host "‚úÖ Repository files downloaded"

    - name: Download MuMu Files
      run: |
        Write-Host "=== DOWNLOADING MUMU FILES ==="
        $whatsappDir = "C:\whatsapp-automation"
        Invoke-WebRequest -Uri "https://a11.gdl.netease.com/MuMu_5.0.4_gw-win-download_all_1756402042.exe?n=MuMu_5.0.4_r9kVqqC.exe" -OutFile "$whatsappDir\MuMu_Installer.exe"
        Write-Host "‚úÖ MuMu Installer downloaded"
        Invoke-WebRequest -Uri "https://github.com/binahmad362/glowing-guide/raw/refs/heads/main/Android%20Device.mumudata?download=" -OutFile "$whatsappDir\Android_Device.mumudata"
        Write-Host "‚úÖ Android Device data downloaded"

    - name: Install Python Dependencies
      run: |
        Write-Host "=== INSTALLING PYTHON DEPENDENCIES ==="
        pip install pyautogui keyboard requests opencv-python pillow pygetwindow
        Write-Host "‚úÖ Python dependencies installed"

    - name: Download Cloudflared
      run: |
        Write-Host "=== DOWNLOADING CLOUDFLARED ==="
        $whatsappDir = "C:\whatsapp-automation"
        Invoke-WebRequest -Uri "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -OutFile "$whatsappDir\cloudflared.exe"
        Write-Host "‚úÖ Cloudflared downloaded"

    - name: Create Web Interface Script
      run: |
        Write-Host "=== CREATING WEB INTERFACE SCRIPT ==="
        $whatsappDir = "C:\whatsapp-automation"
        
        # Create a Python script that provides web interface
        @"
import http.server
import socketserver
import json
import threading
import subprocess
import os
import sys
import pyautogui
import time
from datetime import datetime

class AutomationHandler(http.server.SimpleHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/status':
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            status = {
                "status": "running",
                "timestamp": datetime.now().isoformat(),
                "message": "WhatsApp Automation Server is running"
            }
            self.wfile.write(json.dumps(status).encode())
        elif self.path == '/screenshot':
            try:
                screenshot = pyautogui.screenshot()
                screenshot_path = os.path.join(os.getcwd(), 'screenshot.png')
                screenshot.save(screenshot_path)
                
                self.send_response(200)
                self.send_header('Content-type', 'image/png')
                self.end_headers()
                
                with open(screenshot_path, 'rb') as f:
                    self.wfile.write(f.read())
            except Exception as e:
                self.send_response(500)
                self.send_header('Content-type', 'application/json')
                self.end_headers()
                self.wfile.write(json.dumps({"error": str(e)}).encode())
        else:
            # Serve the HTML interface
            if self.path == '/':
                self.path = '/web_interface.html'
            return http.server.SimpleHTTPRequestHandler.do_GET(self)

    def do_POST(self):
        if self.path == '/run_script':
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            data = json.loads(post_data.decode())
            
            script_name = data.get('script_name', 'script.py')
            
            def run_script():
                try:
                    script_path = os.path.join(os.getcwd(), script_name)
                    if os.path.exists(script_path):
                        subprocess.Popen([sys.executable, script_path])
                    else:
                        print(f"Script {script_path} not found")
                except Exception as e:
                    print(f"Error running script: {e}")
            
            thread = threading.Thread(target=run_script)
            thread.daemon = True
            thread.start()
            
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({"status": "started", "script": script_name}).encode())
        
        elif self.path == '/execute_command':
            content_length = int(self.headers['Content-Length'])
            post_data = self.rfile.read(content_length)
            data = json.loads(post_data.decode())
            
            command = data.get('command', '')
            
            def execute_command():
                try:
                    if command == 'screenshot':
                        screenshot = pyautogui.screenshot()
                        screenshot.save('command_screenshot.png')
                    elif command == 'minimize_all':
                        pyautogui.hotkey('win', 'd')
                    elif command.startswith('type:'):
                        text = command[5:]
                        pyautogui.write(text)
                    elif command.startswith('click:'):
                        coords = command[6:].split(',')
                        if len(coords) == 2:
                            x, y = int(coords[0]), int(coords[1])
                            pyautogui.click(x, y)
                except Exception as e:
                    print(f"Error executing command: {e}")
            
            thread = threading.Thread(target=execute_command)
            thread.daemon = True
            thread.start()
            
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            self.wfile.write(json.dumps({"status": "executed", "command": command}).encode())

# Create web interface HTML
html_content = '''
<!DOCTYPE html>
<html>
<head>
    <title>WhatsApp Automation Control Panel</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 30px; }
        .status { background: #e8f5e8; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .control-panel { background: #f8f9fa; padding: 15px; border-radius: 5px; }
        button { background: #007cba; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a87; }
        .screenshot-container { text-align: center; margin-top: 20px; }
        #screenshot { max-width: 100%; border: 1px solid #ddd; border-radius: 5px; }
        .log { background: #333; color: #fff; padding: 15px; border-radius: 5px; font-family: monospace; height: 200px; overflow-y: auto; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ WhatsApp Automation Control Panel</h1>
            <p>Control your WhatsApp automation through this web interface</p>
        </div>
        
        <div class="status" id="status">
            <strong>Status:</strong> <span id="statusText">Checking...</span>
            <br><strong>Last Update:</strong> <span id="timestamp">-</span>
        </div>
        
        <div class="controls">
            <div class="control-panel">
                <h3>üìú Script Controls</h3>
                <button onclick="runScript('script.py')">Run Main Script</button>
                <button onclick="runScript('desktop_check.py')">Run Desktop Check</button>
                <button onclick="executeCommand('minimize_all')">Minimize All Windows</button>
            </div>
            
            <div class="control-panel">
                <h3>üñ±Ô∏è Quick Actions</h3>
                <button onclick="refreshScreenshot()">Refresh Screenshot</button>
                <button onclick="executeCommand('screenshot')">Take Screenshot</button>
                <div style="margin-top: 10px;">
                    <input type="text" id="customCommand" placeholder="Enter custom command" style="padding: 8px; width: 200px;">
                    <button onclick="executeCustomCommand()">Execute</button>
                </div>
            </div>
        </div>
        
        <div class="screenshot-container">
            <h3>üñ•Ô∏è Live Screenshot</h3>
            <img id="screenshot" src="" alt="Screenshot will appear here">
            <br>
            <button onclick="refreshScreenshot()">Refresh Screenshot</button>
        </div>
        
        <div class="log">
            <h3>üìã Activity Log</h3>
            <div id="logContent"></div>
        </div>
    </div>

    <script>
        let logContent = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logContent = `[${timestamp}] ${message}\n` + logContent;
            document.getElementById('logContent').textContent = logContent;
        }
        
        async function updateStatus() {
            try {
                const response = await fetch('/status');
                const data = await response.json();
                document.getElementById('statusText').textContent = data.message;
                document.getElementById('timestamp').textContent = new Date(data.timestamp).toLocaleString();
            } catch (error) {
                document.getElementById('statusText').textContent = 'Error connecting to server';
            }
        }
        
        async function runScript(scriptName) {
            try {
                const response = await fetch('/run_script', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ script_name: scriptName })
                });
                const data = await response.json();
                log(`Started script: ${data.script}`);
            } catch (error) {
                log(`Error starting script: ${error}`);
            }
        }
        
        async function executeCommand(command) {
            try {
                const response = await fetch('/execute_command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command })
                });
                const data = await response.json();
                log(`Executed command: ${data.command}`);
                if (command === 'screenshot') {
                    setTimeout(refreshScreenshot, 1000);
                }
            } catch (error) {
                log(`Error executing command: ${error}`);
            }
        }
        
        function executeCustomCommand() {
            const command = document.getElementById('customCommand').value;
            if (command) {
                executeCommand(command);
                document.getElementById('customCommand').value = '';
            }
        }
        
        function refreshScreenshot() {
            const screenshot = document.getElementById('screenshot');
            screenshot.src = '/screenshot?' + new Date().getTime();
            log('Screenshot refreshed');
        }
        
        // Initialize
        updateStatus();
        refreshScreenshot();
        setInterval(updateStatus, 5000);
        setInterval(refreshScreenshot, 30000); // Auto-refresh every 30 seconds
        
        log('Control panel initialized');
    </script>
</body>
</html>
'''

with open('web_interface.html', 'w', encoding='utf-8') as f:
    f.write(html_content)

print("Starting web server on port 8080...")
with socketserver.TCPServer(("", 8080), AutomationHandler) as httpd:
    print("Web interface available at http://localhost:8080")
    print("Use Cloudflared tunnel URL to access from browser")
    httpd.serve_forever()
"@ | Out-File -FilePath "$whatsappDir\web_server.py" -Encoding utf8

        Write-Host "‚úÖ Web interface script created"

    - name: Create Cloudflared Tunnel Script
      run: |
        Write-Host "=== CREATING CLOUDFLARED TUNNEL SCRIPT ==="
        $whatsappDir = "C:\whatsapp-automation"
        
        @"
import subprocess
import threading
import time
import re

def start_cloudflared_tunnel(port):
    print(f"Starting Cloudflared tunnel for port {port}...")
    
    def monitor_tunnel():
        process = subprocess.Popen(
            ["cloudflared", "tunnel", "--url", f"http://localhost:{port}"],
            stdout=subprocess.PIPE,
            stderr=subprocess.STDOUT,
            universal_newlines=True
        )
        
        for line in process.stdout:
            print(line, end='')
            if "trycloudflare.com" in line:
                # Extract the URL
                url_match = re.search(r'https://[a-zA-Z0-9-]+\.trycloudflare\.com', line)
                if url_match:
                    tunnel_url = url_match.group(0)
                    print(f"\n{'='*80}")
                    print(f"üéâ YOUR WHATSAPP AUTOMATION IS READY! üéâ")
                    print(f"{'='*80}")
                    print(f"üåê ACCESS URL: {tunnel_url}")
                    print(f"{'='*80}")
                    print(f"üìã Features available:")
                    print(f"   ‚Ä¢ Run automation scripts")
                    print(f"   ‚Ä¢ View live screenshots")
                    print(f"   ‚Ä¢ Execute commands remotely")
                    print(f"   ‚Ä¢ Monitor automation status")
                    print(f"{'='*80}")
        
        process.wait()
    
    thread = threading.Thread(target=monitor_tunnel, daemon=True)
    thread.start()
    return thread

if __name__ == "__main__":
    # Start tunnel for web interface
    tunnel_thread = start_cloudflared_tunnel(8080)
    
    # Keep the script running
    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        print("Shutting down...")
"@ | Out-File -FilePath "$whatsappDir\tunnel_manager.py" -Encoding utf8

        Write-Host "‚úÖ Cloudflared tunnel script created"

    - name: Start Automation Environment
      run: |
        Write-Host "=== STARTING AUTOMATION ENVIRONMENT ==="
        $whatsappDir = "C:\whatsapp-automation"
        cd $whatsappDir
        
        Write-Host "üéâ WHATSAPP AUTOMATION ENVIRONMENT STARTING... üéâ"
        Write-Host ""
        Write-Host "üìã SETUP COMPLETED:"
        Write-Host "   ‚úÖ WhatsApp automation files downloaded"
        Write-Host "   ‚úÖ MuMu emulator files ready"
        Write-Host "   ‚úÖ Python dependencies installed"
        Write-Host "   ‚úÖ Web interface created"
        Write-Host "   ‚úÖ Cloudflared tunnel configured"
        Write-Host ""
        Write-Host "üåê STARTING WEB INTERFACE AND TUNNEL..."
        Write-Host "   Your browser access URL will appear below shortly..."
        Write-Host "   This session will run for 6 hours"
        Write-Host ""
        
        # Start the web server in background
        $webServerJob = Start-Job -ScriptBlock {
            cd C:\whatsapp-automation
            python web_server.py
        }
        
        # Wait a moment for web server to start
        Start-Sleep -Seconds 3
        
        # Start the tunnel manager
        python tunnel_manager.py
        
        Write-Host "=== AUTOMATION COMPLETED ==="
        Write-Host "Cloudflared tunnel will remain active for 6 hours"
        Write-Host "Waiting for 6 hours..."
        Start-Sleep -Seconds 21600

    - name: Upload results as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: whatsapp-automation-results
        path: C:\whatsapp-automation\
        retention-days: 1
